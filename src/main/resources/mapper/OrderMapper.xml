<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.health.api.db.dao.OrderMapper">

    <select id="searchFrontStatistic" parameterType="int" resultType="HashMap">
        SELECT COUNT(*) AS count,
           SUM(amount) AS amount,
           SUM(number) AS number
        FROM tb_order
        WHERE customer_id = #{customerId}
          AND `status` IN (3, 5, 6)
    </select>


    <select id="searchIllegalCountInDay" parameterType="int" resultType="boolean">
        SELECT
        (
        (
        SELECT COUNT(*)
        FROM tb_order
        WHERE customer_id = #{customerId}
        AND create_date = CURRENT_DATE()    -- 今天下单的
          AND status &lt; 3                   -- 状态为未完成的
        ) >= 10                                 -- 是否 >= 10 单
        OR
        (
        SELECT COUNT(*)
        FROM tb_order
        WHERE customer_id = #{customerId}
        AND refund_date = CURRENT_DATE()    -- 今天退款的
        AND status = 4                      -- 状态为“退款成功”
        ) >= 5                                  -- 是否 >= 5 单
        ) AS illegal

    </select>

    <update id="closeOrder">
        UPDATE tb_order
        SET status = 2
        WHERE status = 1
          AND TIMESTAMPDIFF(MINUTE, create_time, NOW()) > 30
    </update>

    <insert id="insert">
        INSERT INTO tb_order
        SET customer_id = #{customerId},
            goods_id = #{goodsId},
            snapshot_id = #{snapshotId},
            goods_title = #{goodsTitle},
            goods_price = #{goodsPrice},
            number = #{number},
            amount = #{amount},
            goods_image = #{goodsImage},
            goods_description = #{goodsDescription},
            out_trade_no = #{outTradeNo},
            status = 1,
            create_date = CURRENT_DATE()
    </insert>

    <update id="updatePayment" parameterType="Map">
        UPDATE tb_order
        SET transaction_id= #{transactionId},
            status = 3
        WHERE out_trade_no = #{outTradeNo}
          AND status = 1
    </update>

    <select id="searchCustomerId" parameterType="String" resultType="Integer">
        SELECT customer_id
        FROM tb_order
        WHERE out_trade_no = #{outTradeNo}
    </select>


</mapper>
